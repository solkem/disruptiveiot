name: Deploy to Ghost

on:
  push:
    branches: [main]
    paths:
      - 'theme/**'
      - 'routes.yaml'
      - 'code-injection/**'
      - '.github/workflows/deploy.yaml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DO_SSH_KEY }}" | base64 -d > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H 143.110.131.196 >> ~/.ssh/known_hosts
      
      - name: Build theme
        run: |
          cd theme/casper
          npm install
          npm run build
          cd ../..

      - name: Deploy theme
        run: rsync -avz --delete --exclude '.git' --exclude '.DS_Store' theme/casper/ root@143.110.131.196:/var/www/ghost/content/themes/casper/
      
      - name: Deploy routes
        run: scp routes.yaml root@143.110.131.196:/var/www/ghost/content/settings/routes.yaml
      
      - name: Deploy code injection
        run: |
          npm install jsonwebtoken
          
          node << 'EOF'
          const jwt = require('jsonwebtoken');
          const https = require('https');
          const fs = require('fs');
          
          const key = "${{ secrets.GHOST_ADMIN_KEY }}";
          const [id, secret] = key.split(':');
          
          const token = jwt.sign({}, Buffer.from(secret, 'hex'), {
            keyid: id,
            algorithm: 'HS256',
            expiresIn: '5m',
            audience: '/admin/'
          });
          
          const content = fs.readFileSync('code-injection/site-header.html', 'utf8');
          
          const data = JSON.stringify({
            settings: [{ key: 'codeinjection_head', value: content }]
          });
          
          const req = https.request({
            hostname: 'disruptiveiot.org',
            path: '/ghost/api/admin/settings/',
            method: 'PUT',
            headers: {
              'Authorization': 'Ghost ' + token,
              'Content-Type': 'application/json',
              'Content-Length': data.length
            }
          }, (res) => {
            let body = '';
            res.on('data', chunk => body += chunk);
            res.on('end', () => console.log('Response:', res.statusCode, body));
          });
          
          req.write(data);
          req.end();
          EOF
      
      - name: Fix permissions and Restart Ghost
        run: ssh root@143.110.131.196 "chown -R ghost:ghost /var/www/ghost/content/themes/casper && cd /var/www/ghost && sudo -u ghost ghost restart"